$(document).ready(function(){
    HitabUtil.init(function(){
        let calendarEl = document.getElementById('content'),
            todo = 0,
            solar = {"1262620800":"小寒","1263916800":"大寒","1265212800":"立春","1266508800":"雨水","1267804800":"惊蛰","1269100800":"春分","1270396800":"清明","1271692800":"谷雨","1272988800":"立夏","1274371200":"小满","1275753600":"芒种","1277049600":"夏至","1278432000":"小暑","1279814400":"大暑","1281110400":"立秋","1282492800":"处暑","1283875200":"白露","1285171200":"秋分","1286467200":"寒露","1287763200":"霜降","1289059200":"立冬","1290355200":"小雪","1291651200":"大雪","1292947200":"冬至","1294243200":"小寒","1295452800":"大寒","1296748800":"立春","1298044800":"雨水","1299340800":"惊蛰","1300636800":"春分","1301932800":"清明","1303228800":"谷雨","1304611200":"立夏","1305907200":"小满","1307289600":"芒种","1308672000":"夏至","1309968000":"小暑","1311350400":"大暑","1312732800":"立秋","1314028800":"处暑","1315411200":"白露","1316707200":"秋分","1318003200":"寒露","1319385600":"霜降","1320681600":"立冬","1321977600":"小雪","1323187200":"大雪","1324483200":"冬至","1325779200":"小寒","1327075200":"大寒","1328284800":"立春","1329580800":"雨水","1330876800":"惊蛰","1332172800":"春分","1333468800":"清明","1334851200":"谷雨","1336147200":"立夏","1337443200":"小满","1338825600":"芒种","1340208000":"夏至","1341590400":"小暑","1342886400":"大暑","1344268800":"立秋","1345651200":"处暑","1346947200":"白露","1348243200":"秋分","1349625600":"寒露","1350921600":"霜降","1352217600":"立冬","1353513600":"小雪","1354809600":"大雪","1356019200":"冬至","1357315200":"小寒","1358611200":"大寒","1359907200":"立春","1361116800":"雨水","1362412800":"惊蛰","1363708800":"春分","1365004800":"清明","1366387200":"谷雨","1367683200":"立夏","1369065600":"小满","1370361600":"芒种","1371744000":"夏至","1373126400":"小暑","1374422400":"大暑","1375804800":"立秋","1377187200":"处暑","1378483200":"白露","1379865600":"秋分","1381161600":"寒露","1382457600":"霜降","1383753600":"立冬","1385049600":"小雪","1386345600":"大雪","1387641600":"冬至","1388851200":"小寒","1390147200":"大寒","1391443200":"立春","1392739200":"雨水","1394035200":"惊蛰","1395331200":"春分","1396627200":"清明","1397923200":"谷雨","1399219200":"立夏","1400601600":"小满","1401984000":"芒种","1403280000":"夏至","1404662400":"小暑","1406044800":"大暑","1407340800":"立秋","1408723200":"处暑","1410105600":"白露","1411401600":"秋分","1412697600":"寒露","1413993600":"霜降","1415289600":"立冬","1416585600":"小雪","1417881600":"大雪","1419177600":"冬至","1420473600":"小寒","1421683200":"大寒","1422979200":"立春","1424275200":"雨水","1425571200":"惊蛰","1426867200":"春分","1428163200":"清明","1429459200":"谷雨","1430841600":"立夏","1432137600":"小满","1433520000":"芒种","1434902400":"夏至","1436198400":"小暑","1437580800":"大暑","1438963200":"立秋","1440259200":"处暑","1441641600":"白露","1442937600":"秋分","1444233600":"寒露","1445616000":"霜降","1446912000":"立冬","1448121600":"小雪","1449417600":"大雪","1450713600":"冬至","1452009600":"小寒","1453219200":"大寒","1454515200":"立春","1455811200":"雨水","1457107200":"惊蛰","1458403200":"春分","1459699200":"清明","1460995200":"谷雨","1462377600":"立夏","1463673600":"小满","1465056000":"芒种","1466438400":"夏至","1467820800":"小暑","1469116800":"大暑","1470499200":"立秋","1471881600":"处暑","1473177600":"白露","1474473600":"秋分","1475856000":"寒露","1477152000":"霜降","1478448000":"立冬","1479744000":"小雪","1481040000":"大雪","1482249600":"冬至","1483545600":"小寒","1484841600":"大寒","1486051200":"立春","1487347200":"雨水","1488643200":"惊蛰","1489939200":"春分","1491235200":"清明","1492617600":"谷雨","1493913600":"立夏","1495296000":"小满","1496592000":"芒种","1497974400":"夏至","1499356800":"小暑","1500652800":"大暑","1502035200":"立秋","1503417600":"处暑","1504713600":"白露","1506096000":"秋分","1507392000":"寒露","1508688000":"霜降","1509984000":"立冬","1511280000":"小雪","1512576000":"大雪","1513872000":"冬至","1515081600":"小寒","1516377600":"大寒","1517673600":"立春","1518969600":"雨水","1520179200":"惊蛰","1521561600":"春分","1522857600":"清明","1524153600":"谷雨","1525449600":"立夏","1526832000":"小满","1528214400":"芒种","1529510400":"夏至","1530892800":"小暑","1532275200":"大暑","1533571200":"立秋","1534953600":"处暑","1536336000":"白露","1537632000":"秋分","1538928000":"寒露","1540224000":"霜降","1541520000":"立冬","1542816000":"小雪","1544112000":"大雪","1545408000":"冬至","1546617600":"小寒","1547913600":"大寒","1549209600":"立春","1550505600":"雨水","1551801600":"惊蛰","1553097600":"春分","1554393600":"清明","1555689600":"谷雨","1557072000":"立夏","1558368000":"小满","1559750400":"芒种","1561046400":"夏至","1562428800":"小暑","1563811200":"大暑","1565193600":"立秋","1566489600":"处暑","1567872000":"白露","1569168000":"秋分","1570464000":"寒露","1571846400":"霜降","1573142400":"立冬","1574352000":"小雪","1575648000":"大雪","1576944000":"冬至","1578240000":"小寒","1579449600":"大寒","1580745600":"立春","1582041600":"雨水","1583337600":"惊蛰","1584633600":"春分","1585929600":"清明","1587225600":"谷雨","1588608000":"立夏","1589904000":"小满","1591286400":"芒种","1592668800":"夏至","1593964800":"小暑","1595347200":"大暑","1596729600":"立秋","1598025600":"处暑","1599408000":"白露","1600704000":"秋分","1602086400":"寒露","1603382400":"霜降","1604678400":"立冬","1605974400":"小雪","1607270400":"大雪","1608480000":"冬至","1609776000":"小寒","1611072000":"大寒","1612281600":"立春","1613577600":"雨水","1614873600":"惊蛰","1616169600":"春分","1617465600":"清明","1618848000":"谷雨","1620144000":"立夏","1621526400":"小满","1622822400":"芒种","1624204800":"夏至","1625587200":"小暑","1626883200":"大暑","1628265600":"立秋","1629648000":"处暑","1630944000":"白露","1632326400":"秋分","1633622400":"寒露","1634918400":"霜降","1636214400":"立冬","1637510400":"小雪","1638806400":"大雪","1640016000":"冬至","1641312000":"小寒","1642608000":"大寒","1643904000":"立春","1645200000":"雨水","1646409600":"惊蛰","1647705600":"春分","1649088000":"清明","1650384000":"谷雨","1651680000":"立夏","1653062400":"小满","1654444800":"芒种","1655740800":"夏至","1657123200":"小暑","1658505600":"大暑","1659801600":"立秋","1661184000":"处暑","1662480000":"白露","1663862400":"秋分","1665158400":"寒露","1666454400":"霜降","1667750400":"立冬","1669046400":"小雪","1670342400":"大雪","1671638400":"冬至","1672848000":"小寒","1674144000":"大寒","1675440000":"立春","1676736000":"雨水","1678032000":"惊蛰","1679328000":"春分","1680624000":"清明","1681920000":"谷雨","1683302400":"立夏","1684598400":"小满","1685980800":"芒种","1687276800":"夏至","1688659200":"小暑","1690041600":"大暑","1691424000":"立秋","1692720000":"处暑","1694102400":"白露","1695398400":"秋分","1696694400":"寒露","1698076800":"霜降","1699372800":"立冬","1700582400":"小雪","1701878400":"大雪","1703174400":"冬至","1704470400":"小寒","1705680000":"大寒","1706976000":"立春","1708272000":"雨水","1709568000":"惊蛰","1710864000":"春分","1712160000":"清明","1713456000":"谷雨","1714838400":"立夏","1716134400":"小满","1717516800":"芒种","1718899200":"夏至","1720195200":"小暑","1721577600":"大暑","1722960000":"立秋","1724256000":"处暑","1725638400":"白露","1726934400":"秋分","1728316800":"寒露","1729612800":"霜降","1730908800":"立冬","1732204800":"小雪","1733414400":"大雪","1734710400":"冬至","1736006400":"小寒","1737302400":"大寒","1738512000":"立春","1739808000":"雨水","1741104000":"惊蛰","1742400000":"春分","1743696000":"清明","1745078400":"谷雨","1746374400":"立夏","1747756800":"小满","1749052800":"芒种","1750435200":"夏至","1751817600":"小暑","1753113600":"大暑","1754496000":"立秋","1755878400":"处暑","1757174400":"白露","1758556800":"秋分","1759852800":"寒露","1761148800":"霜降","1762444800":"立冬","1763740800":"小雪","1765036800":"大雪","1766246400":"冬至","1767542400":"小寒","1768838400":"大寒","1770134400":"立春","1771344000":"雨水","1772640000":"惊蛰","1773936000":"春分","1775318400":"清明","1776614400":"谷雨","1777910400":"立夏","1779292800":"小满","1780588800":"芒种","1781971200":"夏至","1783353600":"小暑","1784736000":"大暑","1786032000":"立秋","1787414400":"处暑","1788710400":"白露","1790092800":"秋分","1791388800":"寒露","1792684800":"霜降","1793980800":"立冬","1795276800":"小雪","1796572800":"大雪","1797868800":"冬至","1799078400":"小寒","1800374400":"大寒","1801670400":"立春","1802966400":"雨水","1804262400":"惊蛰","1805558400":"春分","1806854400":"清明","1808150400":"谷雨","1809532800":"立夏","1810828800":"小满","1812211200":"芒种","1813507200":"夏至","1814889600":"小暑","1816272000":"大暑","1817654400":"立秋","1818950400":"处暑","1820332800":"白露","1821628800":"秋分","1822924800":"寒露","1824220800":"霜降","1825516800":"立冬","1826812800":"小雪","1828108800":"大雪","1829404800":"冬至","1830700800":"小寒","1831910400":"大寒","1833206400":"立春","1834502400":"雨水","1835798400":"惊蛰","1837094400":"春分","1838390400":"清明","1839686400":"谷雨","1841068800":"立夏","1842364800":"小满","1843747200":"芒种","1845129600":"夏至","1846425600":"小暑","1847808000":"大暑","1849190400":"立秋","1850486400":"处暑","1851868800":"白露","1853164800":"秋分","1854547200":"寒露","1855843200":"霜降","1857139200":"立冬","1858435200":"小雪","1859644800":"大雪","1860940800":"冬至","1862236800":"小寒","1863532800":"大寒","1864742400":"立春","1866038400":"雨水","1867334400":"惊蛰","1868630400":"春分","1869926400":"清明","1871308800":"谷雨","1872604800":"立夏","1873987200":"小满","1875283200":"芒种","1876665600":"夏至","1878048000":"小暑","1879344000":"大暑","1880726400":"立秋","1882108800":"处暑","1883404800":"白露","1884787200":"秋分","1886083200":"寒露","1887379200":"霜降","1888675200":"立冬","1889971200":"小雪","1891267200":"大雪","1892476800":"冬至","1893772800":"小寒","1895068800":"大寒","1896364800":"立春","1897574400":"雨水","1898870400":"惊蛰","1900166400":"春分","1901548800":"清明","1902844800":"谷雨","1904140800":"立夏","1905523200":"小满","1906819200":"芒种","1908201600":"夏至","1909584000":"小暑","1910966400":"大暑","1912262400":"立秋","1913644800":"处暑","1914940800":"白露","1916323200":"秋分","1917619200":"寒露","1918915200":"霜降","1920211200":"立冬","1921507200":"小雪","1922803200":"大雪","1924099200":"冬至"},
            holiday = {1577808000:1,1579363200:0,1579795200:1,1579881600:1,1579968000:1,1580054400:1,1580140800:1,1580227200:1,1601136000:0,1580313600:1,1580486400:0,1585929600:1,1586016000:1,1586102400:1,1587830400:0,1588262400:1,1588348800:1,1588435200:1,1588521600:1,1588608000:1,1588953600:0,1593014400:1,1593100800:1,1593187200:1,1593273600:0,1601481600:1,1601568000:1,1601654400:1,1601740800:1,1601827200:1,1601913600:1,1602000000:1,1602086400:1,1602259200:0},
            calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [ 'interaction', 'dayGrid', 'timeGrid', 'list' ],
                height: 'parent',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                navLinks: true, // can click day/week names to navigate views
                businessHours: true, // display business hours
                selectable: true,
                selectMirror: true,
                select: function(arg) {
                    bootbox.prompt({
                        title: 'Add e Event',
                        value: '[✗] ',
                        callback: function(title){
                            if(title){
                                HitabUtil.setRemoteOrLocal('/content/upsert', {
                                    'id': '',
                                    'type': 3,
                                    'name': title,
                                    'status': 0,
                                    'content': JSON.stringify({
                                        start: arg.start,
                                        end: arg.end,
                                        allDay: arg.allDay
                                    })
                                }, function(result){
                                    calendar.addEvent({
                                        title: title,
                                        start: arg.start,
                                        end: arg.end,
                                        allDay: arg.allDay,
                                        extendedProps: {'status': 0}
                                    })
                                }, false);
                            }
                            calendar.unselect()
                        }
                    });
                },
                eventLimit: true, // allow "more" link when too many events
                eventClick: function(calEvent, jsEvent, view){
                    let eventDialog = bootbox.dialog({
                        title: 'Modify Event',
                        message: '<div class="form-group">' +
                            '<input class="form-control" id="event-name" placeholder="Your Event Name" value="'+calEvent.event.title+'">' +
                            '</div>' +
                            '<div class="form-group">' +
                            "        <label class='custom-control custom-switch'>" +
                            "            <input type='checkbox' class='custom-control-input' id='event-status'>" +
                            "            <div class='custom-control-label'>Done!</div>" +
                            "        </label>" +
                            '</div>',
                        onShow: function(e){
                            let domStatus = $('#event-status'), domName = $('#event-name');
                            if(calEvent.event.extendedProps.status){
                                domStatus.prop('checked', true);
                            }
                            domStatus.change(function(){
                                let name = domName.val();
                                name = name.replace('[✗]','').replace('[✓]','').trim();
                                if($(this).is(':checked')){
                                    name = '[✓] ' + name;
                                }else{
                                    name = '[✗] ' + name;
                                }
                                domName.val(name);
                            });
                        },
                        buttons: {
                            cancel: {
                                label: "Cancel",
                            },
                            delete: {
                                label: "Delete",
                                className: 'btn-danger',
                                callback: function(){
                                    bootbox.confirm('Are you sure to delete 【'+calEvent.event.title+'】', function(result){
                                        if(result){
                                            HitabUtil.setRemoteOrLocal('/content/del/' + calEvent.event.id, null, function(){
                                                eventDialog.modal('hide');
                                                calEvent.event.remove();
                                            });
                                        }
                                    });
                                    return false;
                                }
                            },
                            ok: {
                                label: "Save",
                                className: 'btn-success',
                                callback: function(){
                                    let name = $('#event-name').val(), done = $('#event-status').is(':checked');
                                    if(name){
                                        let content = {
                                            extendedProps: {status: calEvent.event.extendedProps.status},
                                            start: calEvent.event.start,
                                            end: calEvent.event.end,
                                            allDay: calEvent.event.allDay
                                        }, setData = {
                                            'id': calEvent.event.id,
                                            'type': 3,
                                            'status': done?1:0,
                                            'name': name,
                                            'content':JSON.stringify(content)
                                        };
                                        HitabUtil.setRemoteOrLocal('/content/upsert', setData, function(result){
                                            calEvent.event.remove();
                                            content.id = calEvent.event.id;
                                            content.title = name;
                                            calendar.addEvent(content);
                                        });
                                    }
                                }
                            }
                        }
                    });
                },
                dayRender: function( dayRender ) {
                    let key = (dayRender.date.valueOf() / 1000 | 0),
                        holidayHtml = '',
                        newDate = new Date(key * 1000);
                    if(holiday.hasOwnProperty(key)){
                        if(holiday[key] == 0){
                            $(dayRender.el).addClass("not-holiday");
                            holidayHtml += '<span class="not-holiday-span">班</span>';
                        }else{
                            $(dayRender.el).addClass("yes-holiday");
                            holidayHtml += '<span class="yes-holiday-span">休</span>';
                        }
                    }
                    $(dayRender.el).html(
                        '<span style="color:#aaa;font-size: 12px;">' +
                        HitabUtil.getLunar(newDate).IDayCn +
                        (solar.hasOwnProperty(key) ? ' - ' + solar[key] : '') +
                        '</span>' + holidayHtml
                    );
                },
                eventRender: function(info) {
                    $(info.el).addClass('event-status-' + info.event.extendedProps.status);
                },
                editable: true
            });
        calendar.render();

        HitabUtil.getLocalOrRemote('/content/get/3/', null, function(data){
            todo = 0;
            calendar.batchRendering(function(){
                for(let i in data){
                    if(data.hasOwnProperty(i)){
                        let exist = calendar.getEventById(data[i].id);
                        if(exist) exist.remove();
                        let content = JSON.parse(data[i].content);
                        content.extendedProps = {};
                        content.id = data[i].id;
                        content.title = data[i].name;
                        content.extendedProps.status = data[i].status;
                        calendar.addEvent(content);
                        if(content.extendedProps.status === 0) todo++;
                    }
                }
                localStorage.setItem('todo', todo);
                HitabUtil.initTodo(todo);
            });
        });
    }, 3);
});